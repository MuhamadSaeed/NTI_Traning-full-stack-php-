<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>students dashboard</h2>
      <button class="btn btn-danger" onclick="logout()">logout</button>
    </div>

    <div class="card mb-4">
      <div class="card-header">add a student</div>
      <div class="card-body">
        <form id="addStudentForm">
          <div class="row g-3">
            <div class="col-md-3">
              <input type="text" class="form-control" placeholder="Name" name="name" required />
            </div>
            <div class="col-md-3">
              <input type="email" class="form-control" placeholder="Email" name="email" required />
            </div>
            <div class="col-md-2">
              <input type="text" class="form-control" placeholder="Phone" name="phone" required />
            </div>
            <div class="col-md-2">
              <input type="date" class="form-control" name="date" required />
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-success w-100">add</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>id</th><th>name</th><th>mail</th><th>phone</th><th>date</th><th>d&u</th>
        </tr>
      </thead>
      <tbody id="studentsTableBody"></tbody>
    </table>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetchStudents();

      document.getElementById("addStudentForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const data = {
          name: form.name.value,
          email: form.email.value,
          phone: form.phone.value,
          date: form.date.value,
        };

        const res = await fetch("../api/add.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        // if (res.status === 401) {
        //   const data = await res.json();
        //   alert(data.message);
        //   location.href = "login.html";
        //   return;
        // }
        
        const result = await res.json();
        if (res.ok) {
          form.reset();
          fetchStudents();
          alert(result.message)
        } else {
            alert(result.message)
        }
      });
    });

    async function fetchStudents() {
      const res = await fetch("../api/get.php");
      if (res.status === 401) {
        const data = await res.json();
        alert(data.message);
        location.href = "login.html";
        return;
      }

      const students = await res.json();
      const tbody = document.getElementById("studentsTableBody");
      tbody.innerHTML = "";

      students.forEach((s) => {
        tbody.innerHTML += `
          <tr data-id="${s.id}">
            <td>${s.id}</td>
            <td><input class="form-control form-control-sm" value="${s.name}" /></td>
            <td><input class="form-control form-control-sm" value="${s.email}" /></td>
            <td><input class="form-control form-control-sm" value="${s.phone}" /></td>
            <td><input type="date" class="form-control form-control-sm" value="${s.date}" /></td>
            <td>
              <button class="btn btn-sm btn-primary me-1" onclick="updateStudent(${s.id})">update</button>
              <button class="btn btn-sm btn-danger" onclick="deleteStudent(${s.id})">delete</button>
            </td>
          </tr>
        `;
      });
    }

    async function updateStudent(id) {
      const row = document.querySelector(`tr[data-id="${id}"]`);
      const inputs = row.querySelectorAll("input");

      const data = {
        id: id,
        name: inputs[0].value,
        email: inputs[1].value,
        phone: inputs[2].value,
        date: inputs[3].value,
      };

      const res = await fetch("../api/update.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const result = await res.json();

      if (res.ok) {
        alert(result.message);
      } else {
        alert(result.message );
      }
    }

    async function deleteStudent(id) {
      const res = await fetch("../api/delete.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id }),
      });
      const result = await res.json();

      if (res.ok) {
        fetchStudents();
        alert(result.message)
    } else {
        alert(result.message)
      }
    }

    async function logout() {
      await fetch("../api/logout.php");
      location.href = "login.html";
    }
  </script>
</body>
</html>
